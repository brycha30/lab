Network Cleanup & VLAN 99 Remediation — Runbook

1. Environment Context

Firewall
- Platform: OPNsense
- LAN Interface: igc0
- WAN Interface: igc1
- LAN Subnet: 192.168.1.0/24
- Gateway: 192.168.1.1
- DHCP Server: ISC dhcpd
  - IPv4 config: /etc/dhcpd.conf (generated by OPNsense)
  - Leases file: /var/dhcpd/var/db/dhcpd.leases
- IPv6: Not intentionally used (link-local only on LAN)

Switching
- Primary PoE Switch: Cisco gbpoe
- Uplink: Gi1/0/26 → Netgear switch
- Test VLAN: VLAN 99 (VLAN0099)
- Production VLAN: VLAN 1

Wireless
- AP Vendor: TP-Link Omada
- AP MAC: 30:68:93:E9:9D:74
- Final AP IP: 192.168.1.24 (static, below .100)
- Omada Controller: Docker LXC on Proxmox (reinstalled during process)

Other Notable Devices
- Smart Business Phone
  - IP: 192.168.1.234
  - MAC: 80:5e:c0:33:df:4d
  - Switch Port: Gi1/0/18

2. Problem Statement

- Test VLAN 99 remained active in the network.
- Main wireless AP was suspected to be connected to or previously provisioned on VLAN 99.
- Symptoms observed:
  - AP not appearing in Omada controller
  - Connectivity instability
  - Performance anomalies
- Additional objective:
  - Enforce no devices below .100 except infrastructure
  - Fully remove test VLAN artifacts

3. Root Cause

1. VLAN 99 remained defined and assigned to at least one switch port (Gi1/0/1).
2. AP previously associated with test VLAN configuration and required:
   - Power reset
   - IP reassignment
   - Re-adoption into Omada
3. Omada Controller container was missing and required reinstallation.
4. VLAN cleanup had not been fully propagated across switching infrastructure.

4. Final Fix / Known-Good Configuration

VLANs
- VLAN 99: Removed from all access ports and no longer used
- VLAN 1: Sole production VLAN for LAN, APs, phones, and clients

IP Addressing
- Infrastructure devices assigned static IPs below .100
- AP assigned 192.168.1.24
- .20–.29 reserved for routers and network devices

IPv6
- Disabled for LAN usage
- Only link-local IPv6 remains (fe80::/64)
- No Router Advertisements (radvd not running)

5. Exact Commands / Configuration Changes

Cisco gbpoe — Remove VLAN 99 from Access Port
Command:
conf t
interface Gi1/0/1
 description cleanup_vlan99_unused
 switchport mode access
 switchport access vlan 1
 spanning-tree portfast
end
wr mem

Verify VLAN Status
Command:
show vlan brief | include 99
show interfaces status

Verify AP MAC Placement
Command:
show mac address-table address 3068.93e9.9d74

Optional: Remove VLAN 99 Entirely (after confirming unused)
Command:
conf t
no vlan 99
end
wr mem

OPNsense — DHCP & ARP Verification
Command:
ps auxww | grep '[d]hcpd'
configctl dhcpd restart

arp -an | grep "30:68:93"

Extract AP lease
Command:
awk 'BEGIN{IGNORECASE=1}
 /lease[[:space:]]+[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+[[:space:]]+\{/ {ip=$2}
 /hardware ethernet 30:68:93:e9:9d:74;/ {print ip}' \
 /var/dhcpd/var/db/dhcpd.leases

IPv6 Confirmation
Command:
ifconfig igc0 | grep inet6
ps auxww | grep '[r]advd' || echo "radvd not running (good)"
netstat -rn -f inet6

AP Recovery Steps
- Power-cycled AP
- Assigned static IP 192.168.1.24
- Reinstalled Omada Controller (Docker LXC)
- Re-adopted AP successfully

6. Verification Steps

Switch
- show mac address-table address 3068.93e9.9d74
- Confirm VLAN = 1

Firewall
- arp -an | grep 192.168.1.24
- ping 192.168.1.24

Omada
- AP visible and online in controller

Network
- Clients obtain correct DHCP leases
- No devices using VLAN 99
- Stable latency and throughput

7. Warnings / Do-Not-Repeat Notes

DO NOT leave test VLANs defined without documented purpose.

DO NOT assign APs to temporary or test VLANs unless controller prof
